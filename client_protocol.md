# Spec
Version 1
Edited on 2018-12-19

## Concept
- **Conn** : a distributed messaging platform for handling RPC easily
- **Application** : a kind of program registered on Conn
- **Client** : a running instance of **Application**
- **Output** : a data which is sent from **Client** to **Conn**
- **Input** : a data receiving from **Conn** to **Client**
- **Function** : a long also can be short running function instance on **Client**, it can send multiple **Output** and receive multiple **Input**
- **Session** : a session of RPC between a client(caller) and another client holding the **Function**

## Convention
- Communicate basing on Websocket
- Use MessagePack for message serialization
- Require **Client Info** in the query of URL of **Conn** Server, e.g. wss://domain:port/?info=ClientInfo
- A **Client** can send out multiple **Output** and receive multiple **Input** in a **Session** with same ***cid***(correlation ID),

## Client Info
urlencoded base64 string of MessagePack binary
- ***app_token*** : string, **required**  
    application token, retrieved from **Conn** after registering your **Application**
- ***version*** : int32, **required**  
    protocol version
- ***name*** : string  
    client name
- ***custom*** : map\<string, any>  
    custom information

## Output
Default use MessagePack for message serialization.
- ***cid*** : string, **required**  
    a unique correlation ID, generated by the client which sent output
- ***type*** : string, **required**  
    refer the following **Output Type**
- ***body*** : bytes, **required**  
    refer the following **Output Body**    

## Input
Default use MessagePack for message serialization.
- ***cid*** : string, **required**  
    a unique correlation ID, generated by the client which sent output
- ***type*** : string, **required**  
    refer the following **Input Type**
- ***body*** : bytes, **required**  
    refer the following **Input Body**

## Output Type
- ***FN*** : register a function instance on **Conn**  
    **Input Type**:
    - ***ON_ERROR*** : received on error
    - ***ON_CALL*** : received on call (Multiple)
    - ***ON_DATA*** : received on next data from caller (Multiple)
    - ***ON_ACK*** : received on acknowledge (Multiple)
- ***CALL*** : start a session to call a function which is registered on **Conn**  
    **Input Type**:
    - ***ON_ERROR*** : received on error
    - ***ON_DATA*** : received on reply from function (Multiple)
    - ***ON_ACK*** : received on acknowledge (Multiple)
- ***NEXT*** : send next data to the caller or function with chunk data in the seession
    **Input Type**:
    - ***ON_ERROR*** : received on error
- ***ACK*** : acknowledge got message
    **Input Type**:
    - ***ON_ERROR*** : received on error

## Output Body
Default use MessagePack for message serialization
- ***FN***
    - ***fn*** : string, **required**  
        function name
    - ***description*** : string, **default is nil**  
        function description
    - ***app_filter*** : map\<string, any>, **default is nil**    
        a filter for receiving message from which **Application**
        ```javascript
        //form:{ <field1>: {<operator>:<value>, ...}, ... }
        //e.g.
        {
            "app":{
                "$expreg":"^com.github.xy02"
            },
            "version":{
                "$gte":2,
                "$lt": 10,
            }
        }
        ```
    - ***client_filter*** : map\<string, any>, **default is nil**   
        a filter for receiving message from which **Client**
        ```javascript
        //form:{ <field1>: {<operator>:<value>, ...}, ... }
        //e.g.
        {
            "ip":{
                "$expreg":"192.168.1."
            },
            "name":"client A",
            "custom":{
                "foo": {
                    "$gt": 11,
                    "$lte":20
                },
                "bar": "test"
            }
        }
        ```
- ***CALL***
    - ***app*** : string, **required**
        application name
    - ***fn*** : string, **required**
        function name
    - ***sid*** : string, **required**  
        a unique session ID on call, generated by the caller
    - ***chunk_type*** : string, **default is nil**  
        type of chunk data
    - ***chunk*** : bytes, **default is nil**    
        chunk data
    - ***take*** : int32, **default is 0**  
        indicate the number of further message that the caller want to take from the function in the session, little than 0 means reject any further message and close session, 0 means accept messages with no limit
    - ***client_filter*** : map\<string, any>, **default is nil**  
        a filter for sending message to which **Client**
        ```javascript
        //form:{ <field1>: {<operator>:<value>, ...}, ... }
        //e.g.
        {
            "ip":{
                "$expreg":"192.168.1."
            },
            "name":"client A",
            "custom":{
                "foo": {
                    "$gt": 11,
                    "$lte":20
                },
                "bar": "test"
            }
        }
        ```
- ***DATA***
    - ***sid*** : string, **required**  
        a unique session ID on call, generated by the caller
    - ***sn***: int64, **required**  
        serial number of this message from function/caller to caller/function in the session, start from 0 and plus 1 on every next data for both direction
    - ***chunk_type*** : string, **default is nil**  
        type of chunk data
    - ***chunk*** : bytes, **default is nil**    
        chunk data
    - ***take*** : int32, **default is 0**  
        indicate the number of further message that the function/caller want to take from the caller/function in the session, little than 0 means reject any further message and close session, 0 means accept messages with no limit
    - ***ack*** : bool, **default is false**  
        indicate caller or fucntion whether to acknowledge that this message is recevied
- ***ACK***
    - ***sid*** : string, **required**  
        a unique session ID on call, generated by the caller
    - ***sn***: int64, **required**  
        serial number of this message from function/caller to caller/function in the session, start from 0 and plus 1 on every NEXT data for both direction

## Input Body
Default use MessagePack for message serialization
- ***ON_ERROR***
    - ***message*** : string, **required**  
        error message
- ***ON_CALL***
    - ***sid*** : string, **required**  
        a unique session ID on call, generated by the caller
    - ***chunk_type*** : string, **default is nil**  
        type of chunk data
    - ***chunk*** : bytes, **default is nil**  
        chunk data
    - ***take*** : int32, **default is 0**  
        indicate the number of further message that the caller want to take from the **Function** in this session, little than 0 means reject any further message and close session, 0 means accept messages with no limit
- ***ON_DATA***
    - ***sid*** : string, **required**  
        a unique session ID on call, generated by the caller
    - ***sn***: int64, **required**  
        serial number of this message from function/caller to caller/function in the session, start from 0 and plus 1 on every next data for both direction
    - ***chunk_type*** : string, **default is nil**  
        type of chunk data
    - ***chunk*** : bytes, **default is nil**    
        chunk data
    - ***take*** : int32, **default is 0**  
        indicate the number of further message that the function/caller want to take from the caller/function in the session, little than 0 means reject any further message and close session, 0 means accept messages with no limit
    - ***ack*** : bool, **default is false**  
        indicate caller or fucntion whether to acknowledge that this message is recevied
- ***ON_ACK***
    - ***sid*** : string, **required**  
        a unique session ID on call, generated by the caller
    - ***sn***: int64, **required**  
        serial number of this message from function/caller to caller/function in the session, start from 0 and plus 1 on every NEXT data for both direction